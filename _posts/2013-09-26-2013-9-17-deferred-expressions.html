---
layout: post
title: Deferred Expressions in JSP
date: 2013-09-26 22:36:26.000000000 -05:00
categories: []
tags:
- JSP
- Tag Library
status: publish
type: post
published: true
meta:
author: Aaron Johnson
---
<p>JSP 2.1 introduced the Unified Expression Language. &nbsp;This combined the EL syntax from the JSP and JSF specifications. &nbsp;One of the features that this introduced for JSP tags is the concept of a deferred evaluation of expressions. &nbsp;The syntax is slightly different when using a tag that is expecting a deferred expression. &nbsp;A deferred expression is indicated by the '#' symbol and a run-time expression uses the '$' symbol.</p>
<pre class="source-code"><span class="cm-tag">&lt;foo:deferred</span> <span class="cm-attribute">value</span>=<span class="cm-string">"#{firstName}"</span> <span class="cm-tag">/&gt;</span><br /><span class="cm-tag">&lt;foo:runtime</span> <span class="cm-attribute">value</span>=<span class="cm-string">"${firstName}"</span> <span class="cm-tag">/&gt;</span></pre>
<p>A page author can not just choose to use a deferred expression instead of a run-time one. &nbsp;The tag that is being used has to define the attribute in the tag library differently.</p>
<pre class="source-code"><span class="cm-meta">&lt;?xml</span> <span class="cm-meta">version="1.0" encoding="UTF-8"?&gt;</span><br /><span class="cm-tag">&lt;taglib</span> <span class="cm-attribute">xmlns</span>=<span class="cm-string">"http://java.sun.com/xml/ns/javaee"</span><br />  <span class="cm-attribute">xmlns:xsi</span>=<span class="cm-string">"http://www.w3.org/2001/XMLSchema-instance"</span><br />  <span class="cm-attribute">xsi:schemaLocation</span>=<span class="cm-string">"http://java.sun.com/xml/ns/javaee</span><br />  <span class="cm-string">http://java.sun.com/xml/ns/javaee/web-jsptaglibrary_2_1.xsd"</span><br />  <span class="cm-attribute">version</span>=<span class="cm-string">"2.1"</span><span class="cm-tag">&gt;</span><br />    <span class="cm-tag">&lt;tag</span><span class="cm-tag">&gt;</span><br />      <span class="cm-comment">&lt;!-- Runtime value attribute definition --&gt;</span><br />      <span class="cm-tag">&lt;attribute</span><span class="cm-tag">&gt;</span><br />        <span class="cm-tag">&lt;name</span><span class="cm-tag">&gt;</span>value<span class="cm-tag">&lt;/name</span><span class="cm-tag">&gt;</span><br />        <span class="cm-tag">&lt;rtexprvalue</span><span class="cm-tag">&gt;</span>true<span class="cm-tag">&lt;/rtexprvalue</span><span class="cm-tag">&gt;</span><br />      <span class="cm-tag">&lt;/attribute</span><span class="cm-tag">&gt;</span><br />      <span class="cm-comment">&lt;!-- Deferred value attribute definition --&gt;</span><br />      <span class="cm-tag">&lt;attribute</span><span class="cm-tag">&gt;</span><br />        <span class="cm-tag">&lt;name</span><span class="cm-tag">&gt;</span>value<span class="cm-tag">&lt;/name</span><span class="cm-tag">&gt;</span><br />        <span class="cm-tag">&lt;deferred-value</span><span class="cm-tag">&gt;</span><br />          <span class="cm-tag">&lt;type</span><span class="cm-tag">&gt;</span>java.util.Date<span class="cm-tag">&lt;/type</span><span class="cm-tag">&gt;</span><br />        <span class="cm-tag">&lt;/deferred-value</span><span class="cm-tag">&gt;</span><br />      <span class="cm-tag">&lt;/attribute</span><span class="cm-tag">&gt;</span><br />    <span class="cm-tag">&lt;/tag</span><span class="cm-tag">&gt;</span><br /><span class="cm-tag">&lt;/taglib</span><span class="cm-tag">&gt;</span></pre>
<p>Why would a tag use a deferred value? &nbsp;JSP doesn't separate the evaluation of the page and the generation of the markup like JSF. &nbsp;The deferred expression doesn't have the same obvious applications as in JSF. &nbsp;I can think of a few situations where it is helpful.</p>
<ul>
<li>The un-evaluated expression string is useful</li>
<li>The tag needs to modify the javax.el.ELContext (page scope variables, etc) before the expression is valid</li>
<li>The expression needs to be conditionally evaluated</li>
</ul>
<h1>Using the Expression String</h1>
<p>I have used the expression string to generate the names of HTTP parameters. &nbsp;This is useful when your application uses a web framework that binds parameters to a JavaBean. &nbsp;A common tag is a page selector for a table with many rows that will not fit on a single page. &nbsp;Here is an example that uses deferred expressions.</p>
<pre class="source-code"><span class="cm-tag">&lt;tag:pager</span> <span class="cm-attribute">pageSize</span>=<span class="cm-string">"#{pgSz}"</span> <span class="cm-attribute">firstResult</span>=<span class="cm-string">"#{index}"</span> <span class="cm-tag">/&gt;</span></pre>
<p>The tag can access the string used to create the expression via the <a href="http://docs.oracle.com/javaee/7/api/javax/el/Expression.html#getExpressionString()" target="_blank">javax.el.ValueExpression.getExpressionString()</a> method. &nbsp;This allows the tag to emit anchor tags that contain the correct parameter name that specifies page size and first result values; http://.../search?pgSz=50&amp;index=50. &nbsp;If the expression string could not be inspected then the request parameters would need to be passed in as attributes or hard coded in the tag. &nbsp;It is important to realize that this will only work if the expression is not a formula. &nbsp;For instance: #{1 + pgSz}. &nbsp;The expression string would not make a good parameter name.</p>
<h1>Iteration without a Body</h1>
<p>Iteration tags typically have an attribute that takes an iterable and then evaluate the tag body for each item in the iterable. &nbsp;Simple iteration tags no longer need to have a body if the usage of the variable can be expressed in a couple deferred expressions. &nbsp;An example of this is a tag that generates an HTML select element.</p>
<pre class="source-code"><span class="cm-tag">&lt;tag:select</span> <span class="cm-attribute">name</span>=<span class="cm-string">"color"</span> <span class="cm-attribute">options</span>=<span class="cm-string">"${colors}"</span> <span class="cm-attribute">var</span>=<span class="cm-string">"colorVar"</span><br />  <span class="cm-attribute">optionLabel</span>=<span class="cm-string">"#{colorVar.label}"</span> <span class="cm-attribute">optionValue</span>=<span class="cm-string">"#{colorVar.hex}"</span> <span class="cm-tag">/&gt;</span></pre>
<p>The optionLabel and optionValue attributes are using deferred expressions. &nbsp;The evaluation of the expression depends on a page scope variable specified by the var attribute. &nbsp;A deferred expression can be evaluated more than once. &nbsp;This tag would iterate over the colors passed in, exposing the 'colorVar' variable each iteration and then evaluating the deferred expressions to generate the HTML option elements that are nested inside of the select element.</p>
<h1>Conditional Evaluation</h1>
<p>The tag is responsible for invoking the evaluation of a deferred expression. &nbsp;This can be used when the evaluation modifies state or if the evaluation is known to be expensive.</p></p>
<pre class="source-code"><span class="cm-tag">&lt;tag:table</span><span class="cm-tag">&gt;</span><br />  <span class="cm-tag">&lt;tag:column</span> <span class="cm-attribute">header</span>=<span class="cm-string">"#{msg['resource.key']}"</span><span class="cm-tag">&gt;</span><br />    Column Data<br />  <span class="cm-tag">&lt;/tag:column</span><span class="cm-tag">&gt;</span><br /><span class="cm-tag">&lt;/tag:table</span><span class="cm-tag">&gt;</span></pre>
<p>The tags used above render an HTML table. &nbsp;The header text is only needed for rendering the header row. &nbsp;If the application uses a database to hold/override text keys then the expression might result in a database query if the key wasn't loaded or had been evicted from cache. &nbsp;Using the deferred expression allows the tag to only evaluate the expression when the header text is needed; not for every invocation of the tag body as the table tag iterates over the items in the table.&nbsp;</p>
